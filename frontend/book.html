<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Details - Turo Clone</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        .detail-carousel {
            height: 400px;
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 3rem;
        }

        .booking-sidebar {
            background: white;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        @media (max-width: 992px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }

            .booking-sidebar {
                position: static;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="container nav-container">
            <a href="index.html" class="logo">Turo Clone</a>
            <div class="burger"><span></span><span></span><span></span></div>
            <nav class="nav-links">
                <a href="cars.html">Browse Cars</a>
                <div id="auth-links" style="display: flex; gap: 2rem; align-items: center;"></div>
            </nav>
        </div>
    </header>

    <main class="container py-5">
        <div id="car-detail-view" style="margin-top: 2rem;">
            <!-- Loading -->
            <p>Preparing the vehicle details...</p>
        </div>
    </main>

    <!-- Modals -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-card">
            <span class="close-modal">&times;</span>
            <h2 style="margin-bottom: 1rem;">Login to Book</h2>
            <div class="message" style="display: none; margin-bottom: 1rem;"></div>
            <form id="loginForm">
                <div class="form-group"><label>Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Log In</button>
            </form>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const carId = urlParams.get('id');

        async function loadDetails() {
            if (!carId) { window.location.href = 'cars.html'; return; }
            try {
                const response = await api.get(`/cars/${carId}`);
                const car = await response.json();
                const container = document.getElementById('car-detail-view');

                container.innerHTML = `
                    <section class="carousel detail-carousel" id="detail-carousel">
                        <div class="carousel-inner">
                            <div class="carousel-item active"><img src="https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1200&q=80"></div>
                            <div class="carousel-item"><img src="https://images.unsplash.com/photo-1552519507-da3b142c6e3d?auto=format&fit=crop&w=1200&q=80"></div>
                        </div>
                    </section>

                    <div class="detail-grid">
                        <div class="main-info">
                            <h1 style="font-size: 3rem; font-weight: 800; line-height: 1;">${car.year} ${car.make} ${car.model}</h1>
                            <p style="font-size: 1.1rem; color: var(--text-muted); margin-top: 0.5rem;">üìç ${car.location}</p>
                            
                            <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">
                            
                            <h3 style="font-weight: 800; margin-bottom: 1rem;">Description</h3>
                            <p style="font-size: 1.1rem; color: var(--text-muted);">${car.description || 'This immaculate vehicle is perfect for any occasion. Exceptionally maintained and ready for your next adventure.'}</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem;">
                                <div style="background: var(--bg-alt); padding: 1rem; border-radius: 12px;">
                                    <p style="font-size: 0.8rem; font-weight: 800; color: var(--text-muted);">FEATURES</p>
                                    <p>Bluetooth, GPS, Heated Seats</p>
                                </div>
                                <div style="background: var(--bg-alt); padding: 1rem; border-radius: 12px;">
                                    <p style="font-size: 0.8rem; font-weight: 800; color: var(--text-muted);">ENGINE</p>
                                    <p>AWD, High Performance</p>
                                </div>
                            </div>
                        </div>

                        <aside class="booking-sidebar">
                            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2rem;">
                                <span style="font-size: 2rem; font-weight: 800;">$${car.price_per_day} <small style="font-size: 0.9rem; font-weight: 400; color: var(--text-muted)">/ day</small></span>
                                <span style="font-weight: 700;">‚òÖ 5.0</span>
                            </div>

                            <form id="booking-form">
                                <div class="form-group">
                                    <label>TRIP START</label>
                                    <input type="date" id="startDate" required>
                                </div>
                                <div class="form-group">
                                    <label>TRIP END</label>
                                    <input type="date" id="endDate" required>
                                </div>
                                <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 1.1rem; padding: 1rem; margin-top: 1rem;">Book Now</button>
                            </form>
                            <p id="booking-msg" style="text-align: center; margin-top: 1rem; display: none;"></p>
                        </aside>
                    </div>
                `;

                new Carousel('detail-carousel', 4000);
                document.getElementById('booking-form').addEventListener('submit', (e) => handleBooking(e, car.id));

            } catch (err) {
                console.error(err);
                document.getElementById('car-detail-view').innerHTML = '<p>Error loading details.</p>';
            }
        }

        async function handleBooking(e, id) {
            e.preventDefault();
            if (!localStorage.getItem('token')) {
                modals.open('login-modal');
                return;
            }

            const payload = {
                car_id: id,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value
            };

            const msg = document.getElementById('booking-msg');
            try {
                const response = await api.post('/bookings/', payload);
                if (response.ok) {
                    msg.innerText = "Successfully booked! Redirecting...";
                    msg.style.color = "green";
                    msg.style.display = "block";
                    setTimeout(() => window.location.href = 'dashboard.html', 1500);
                } else {
                    const data = await response.json();
                    msg.innerText = data.detail || "Booking failed.";
                    msg.style.color = "red";
                    msg.style.display = "block";
                }
            } catch (error) {
                msg.innerText = "Network error.";
                msg.style.color = "red";
                msg.style.display = "block";
            }
        }

        loadDetails();

        // Login handle
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new URLSearchParams();
            formData.append('username', document.getElementById('login-email').value);
            formData.append('password', document.getElementById('login-password').value);
            const res = await fetch('https://carhive.onrender.com/api/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem('token', data.access_token);
                localStorage.setItem('isLoggedIn', 'true');
                window.location.reload();
            } else {
                alert('Login failed. Please check credentials.');
            }
        });
    </script>
</body>

</html>


